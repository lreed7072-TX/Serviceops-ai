generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  DISPATCHER
  TECH
}

enum InviteStatus {
  PENDING
  ACCEPTED
  REVOKED
  EXPIRED
}

enum WorkOrderStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum ExecutionMode {
  UNIFIED
  MULTI_LANE
}

enum WorkPackageType {
  MECH_ELEC_UNIFIED
  MECHANICAL
  ELECTRICAL
  CONTROLS
  INSTRUMENTATION
}

enum AssetStatus {
  ACTIVE
  INACTIVE
  RETIRED
}

enum AssetCriticality {
  LOW
  MEDIUM
  HIGH
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  BLOCKED
  SKIPPED
}

enum TaskEvidenceType {
  NOTE
  PHOTO
  FILE
}

enum VisitStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  BLOCKED
}

enum ReportTemplateStatus {
  DRAFT
  ACTIVE
  ARCHIVED
}

enum ReportBlockType {
  HEADING
  RICH_TEXT
  TABLE
  IMAGE
}

model Org {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  invites      Invite[]
  customers    Customer[]
  sites        Site[]
  assets       Asset[]
  workOrders   WorkOrder[]
  visits       Visit[]
  findings     Finding[]
  measures     Measurement[]
  files        File[]
  reports      Report[]
  kbFiles      KbFile[]
  kbChunks     KbChunk[]
  workPackages WorkPackage[]
  tasks        TaskInstance[]
  taskEvidence TaskEvidence[]
  reportTemplates ReportTemplate[]
  reportBlocks ReportBlock[]
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  orgId     String   @db.Uuid
  email     String
  name      String?
  role      Role     @default(TECH)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org            Org           @relation(fields: [orgId], references: [id])
  invitesSent    Invite[]      @relation("InviteSentBy")
  assignedVisits Visit[]       @relation("VisitAssignedTech")
  leadPackages   WorkPackage[]   @relation("WorkPackageLead")
  assignedTasks  TaskInstance[]  @relation("TaskAssignedTo")
  createdTaskEvidence TaskEvidence[] @relation("TaskEvidenceCreatedBy")
  createdReportTemplates ReportTemplate[] @relation("ReportTemplateCreatedBy")
  updatedReportTemplates ReportTemplate[] @relation("ReportTemplateUpdatedBy")

  @@unique([orgId, email])
  @@index([orgId])
}

model Invite {
  id          String       @id @default(uuid()) @db.Uuid
  orgId       String       @db.Uuid
  email       String
  role        Role
  token       String       @unique
  status      InviteStatus @default(PENDING)
  expiresAt   DateTime
  invitedById String?      @db.Uuid
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  org       Org   @relation(fields: [orgId], references: [id])
  invitedBy User? @relation("InviteSentBy", fields: [invitedById], references: [id])

  @@index([orgId])
  @@index([orgId, email])
}

model Customer {
  id        String   @id @default(uuid()) @db.Uuid
  orgId     String   @db.Uuid
  name      String
  status    String   @default("ACTIVE")
  primaryEmail  String?
  primaryPhone  String?
  billingAddress String?
  notes         String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org       Org        @relation(fields: [orgId], references: [id])
  sites     Site[]
  assets    Asset[]
  workOrders WorkOrder[]

  @@index([orgId])
}

model Site {
  id         String   @id @default(uuid()) @db.Uuid
  orgId      String   @db.Uuid
  customerId String   @db.Uuid
  name       String
  address    String?
  city       String?
  state      String?
  postalCode String?
  country    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  org      Org      @relation(fields: [orgId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])
  assets   Asset[]
  workOrders WorkOrder[]

  @@index([orgId])
  @@index([orgId, customerId])
}

model Asset {
  id                     String            @id @default(uuid()) @db.Uuid
  orgId                  String            @db.Uuid
  customerId             String            @db.Uuid
  siteId                 String            @db.Uuid
  name                   String
  manufacturer           String?
  model                  String?
  serialNumber           String?
  assetTag               String?
  location               String?
  notes                  String?
  status                 AssetStatus       @default(ACTIVE)
  criticality            AssetCriticality?
  nameplateSchemaVersion Int               @default(1)
  nameplate              Json?
  createdAt              DateTime          @default(now())
  updatedAt              DateTime          @updatedAt

  org        Org        @relation(fields: [orgId], references: [id])
  customer   Customer   @relation(fields: [customerId], references: [id])
  site       Site       @relation(fields: [siteId], references: [id])
  workOrders WorkOrder[]

  @@index([orgId])
  @@index([orgId, siteId])
  @@index([orgId, customerId])
}

model WorkOrder {
  id          String          @id @default(uuid()) @db.Uuid
  orgId       String          @db.Uuid
  customerId  String          @db.Uuid
  siteId      String          @db.Uuid
  assetId     String?         @db.Uuid
  title       String
  description String?
  status      WorkOrderStatus @default(OPEN)
  executionMode ExecutionMode @default(UNIFIED)
  workOrderNumber String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  org      Org      @relation(fields: [orgId], references: [id])
  customer Customer @relation(fields: [customerId], references: [id])
  site     Site     @relation(fields: [siteId], references: [id])
  asset    Asset?   @relation(fields: [assetId], references: [id])
  visits   Visit[]
  packages WorkPackage[]
  tasks    TaskInstance[]

  @@index([orgId])
  @@index([orgId, customerId])
  @@unique([orgId, workOrderNumber])
}

model WorkPackage {
  id          String          @id @default(uuid()) @db.Uuid
  orgId       String          @db.Uuid
  workOrderId String          @db.Uuid
  packageType WorkPackageType
  name        String
  status      String          @default("PLANNED")
  leadTechId  String?         @db.Uuid
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  org       Org       @relation(fields: [orgId], references: [id])
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id])
  leadTech  User?     @relation("WorkPackageLead", fields: [leadTechId], references: [id])
  tasks     TaskInstance[]

  @@index([orgId])
  @@index([orgId, workOrderId])
}

model TaskInstance {
  id            String      @id @default(uuid()) @db.Uuid
  orgId         String      @db.Uuid
  workOrderId   String      @db.Uuid
  workPackageId String      @db.Uuid
  title         String
  description   String?
  status        TaskStatus  @default(TODO)
  sequenceNumber Int?
  assignedToId  String?     @db.Uuid
  isCritical    Boolean     @default(false)
  requiresEvidence Boolean  @default(false)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  org        Org         @relation(fields: [orgId], references: [id])
  workOrder  WorkOrder   @relation(fields: [workOrderId], references: [id])
  workPackage WorkPackage @relation(fields: [workPackageId], references: [id])
  assignedTo User?       @relation("TaskAssignedTo", fields: [assignedToId], references: [id])
  evidence   TaskEvidence[]

  @@index([orgId])
  @@index([orgId, workOrderId])
  @@index([orgId, workPackageId])
}

model TaskEvidence {
  id              String           @id @default(uuid()) @db.Uuid
  orgId           String           @db.Uuid
  taskInstanceId  String           @db.Uuid
  type            TaskEvidenceType
  noteText        String?
  url             String?
  createdByUserId String           @db.Uuid
  createdAt       DateTime         @default(now())

  org           Org         @relation(fields: [orgId], references: [id])
  taskInstance  TaskInstance @relation(fields: [taskInstanceId], references: [id])
  createdByUser User        @relation("TaskEvidenceCreatedBy", fields: [createdByUserId], references: [id])

  @@index([orgId])
  @@index([orgId, taskInstanceId])
  @@index([orgId, createdByUserId])
}

model Visit {
  id             String     @id @default(uuid()) @db.Uuid
  orgId          String     @db.Uuid
  workOrderId    String     @db.Uuid
  assignedTechId String?    @db.Uuid
  status         VisitStatus @default(PLANNED)
  scheduledFor   DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  summary        String?
  outcome        String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  org        Org      @relation(fields: [orgId], references: [id])
  workOrder  WorkOrder @relation(fields: [workOrderId], references: [id])
  assignedTech User?   @relation("VisitAssignedTech", fields: [assignedTechId], references: [id])
  findings   Finding[]
  measures   Measurement[]
  files      File[]
  reports    Report[]

  @@index([orgId])
  @@index([orgId, workOrderId])
}

model Finding {
  id        String   @id @default(uuid()) @db.Uuid
  orgId     String   @db.Uuid
  visitId   String   @db.Uuid
  category  String
  details   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org   Org   @relation(fields: [orgId], references: [id])
  visit Visit @relation(fields: [visitId], references: [id])

  @@index([orgId])
  @@index([orgId, visitId])
}

model Measurement {
  id        String   @id @default(uuid()) @db.Uuid
  orgId     String   @db.Uuid
  visitId   String   @db.Uuid
  name      String
  value     String
  unit      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org   Org   @relation(fields: [orgId], references: [id])
  visit Visit @relation(fields: [visitId], references: [id])

  @@index([orgId])
  @@index([orgId, visitId])
}

model File {
  id         String   @id @default(uuid()) @db.Uuid
  orgId      String   @db.Uuid
  visitId    String?  @db.Uuid
  reportId   String?  @db.Uuid
  kbFileId   String?  @db.Uuid
  filename   String
  mimeType   String
  storageKey String
  sizeBytes  Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  org    Org     @relation(fields: [orgId], references: [id])
  visit  Visit?  @relation(fields: [visitId], references: [id])
  report Report? @relation(fields: [reportId], references: [id])
  kbFile KbFile? @relation(fields: [kbFileId], references: [id])

  @@index([orgId])
  @@index([orgId, visitId])
}

model Report {
  id        String   @id @default(uuid()) @db.Uuid
  orgId     String   @db.Uuid
  visitId   String   @db.Uuid
  title     String
  status    String   @default("DRAFT")
  content   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org    Org   @relation(fields: [orgId], references: [id])
  visit  Visit @relation(fields: [visitId], references: [id])
  files  File[]

  @@index([orgId])
  @@index([orgId, visitId])
}

model ReportTemplate {
  id              String               @id @default(uuid()) @db.Uuid
  orgId           String               @db.Uuid
  name            String
  description     String?
  status          ReportTemplateStatus @default(DRAFT)
  schemaVersion   Int                  @default(1)
  definition      Json
  createdByUserId String               @db.Uuid
  updatedByUserId String?              @db.Uuid
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt

  org           Org  @relation(fields: [orgId], references: [id])
  createdByUser User @relation("ReportTemplateCreatedBy", fields: [createdByUserId], references: [id])
  updatedByUser User? @relation("ReportTemplateUpdatedBy", fields: [updatedByUserId], references: [id])
  blocks        ReportBlock[] @relation("ReportTemplateBlocks")

  @@index([orgId])
  @@index([orgId, status])
}

model ReportBlock {
  id               String          @id @default(uuid()) @db.Uuid
  orgId            String          @db.Uuid
  reportTemplateId String          @db.Uuid
  type             ReportBlockType
  title            String?
  props            Json
  sortOrder        Int             @default(0)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  org            Org            @relation(fields: [orgId], references: [id])
  reportTemplate ReportTemplate @relation("ReportTemplateBlocks", fields: [reportTemplateId], references: [id])

  @@index([orgId])
  @@index([orgId, reportTemplateId])
  @@index([orgId, reportTemplateId, sortOrder])
}

model KbFile {
  id           String   @id @default(uuid()) @db.Uuid
  orgId        String   @db.Uuid
  title        String
  sourceUrl    String?
  status       String   @default("ACTIVE")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  org     Org      @relation(fields: [orgId], references: [id])
  files   File[]
  chunks  KbChunk[]

  @@index([orgId])
}

model KbChunk {
  id         String   @id @default(uuid()) @db.Uuid
  orgId      String   @db.Uuid
  kbFileId   String   @db.Uuid
  content    String
  tokenCount Int?
  embedding  Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  org    Org    @relation(fields: [orgId], references: [id])
  kbFile KbFile @relation(fields: [kbFileId], references: [id])

  @@index([orgId])
  @@index([orgId, kbFileId])
}

model user_org_roles {
  user_id String @db.Uuid
  org_id  String @db.Uuid
  role    Role

  @@id([user_id, org_id])
  @@index([user_id])
}

